name: Deploy to cPanel

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Deploy
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    steps:
      - name: Install dependencies
        run: |
          apk add --no-cache git libwebp-tools php php-json php-curl
      
      - name: Get latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for changed-files action
      
      - name: Configure git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      
      - name: Get changed image files
        id: changed-images
        uses: step-security/changed-files@v46
        with:
          files: |
            **/*.jpg
            **/*.jpeg
            **/*.png
      
      - name: Convert changed images to WebP
        if: steps.changed-images.outputs.any_changed == 'true'
        run: |
          echo "Converting changed images to WebP..."
          for file in ${{ steps.changed-images.outputs.all_changed_files }}; do
            echo "Converting: $file"
            cwebp -q 90 -m 6 "$file" -o "${file%.*}.webp"
          done
          echo "Done converting ${{ steps.changed-images.outputs.changed_files_count }} image(s)"
      
      - name: Warm Up Geolocation Cache
        run: php tools/warm-cache.php
      
      - name: Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # We assume your FTP account is rooted to the correct folder. 
          # If not, change './' to 'test/2e2erc/'
          server-dir: ./
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            data/signups.json
            tools/**


